<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Evaluation Survey</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max_width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .audio-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        audio {
            width: 100%;
            max-width: 500px;
        }

        .question {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .question label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
        }

        .options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
        }

        button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        #loading {
            text-align: center;
            color: #666;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            width: 100%;
            max-width: 300px;
        }

        .setup-notice {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ffeeba;
        }

        /* Login Screen Styles */
        #login-screen {
            text-align: center;
            padding: 40px 20px;
        }

        #login-name {
            padding: 15px;
            font-size: 16px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ì˜¤ë””ì˜¤ ì²­ì·¨ í‰ê°€<br>Audio Listening Evaluation</h1>

        <!-- Google Script URL ì…ë ¥ ì•ˆë‚´ (ë°°í¬ ì‹œ ì œê±°í•˜ê±°ë‚˜ hiddenìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥) -->
        <div id="setup-area" class="setup-notice hidden">
            <h3>âš ï¸ ì„¤ì • í•„ìš”</h3>
            <p>Google Apps Script ë°°í¬ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input type="text" id="script-url"
                placeholder="https://script.google.com/macros/s/AKfycbxBNEsHy5YneuaABdGLnMvvrkKIO1pWu79GRw8QoOmFZ72HFA01XQAdxbNW92FQXkvm/exec"
                style="width: 100%; padding: 8px; margin-top: 5px;">
            <button onclick="saveScriptUrl()" style="margin-top: 10px; width: auto;">URL ì €ì¥ ë° ì‹œì‘</button>
        </div>

        <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="login-screen">
            <h3>í‰ê°€ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</h3>
            <input type="text" id="login-name" placeholder="ì´ë¦„ (ì˜ˆ: ì„ì£¼ì€)" required>
            <button onclick="startSurvey()">í‰ê°€ ì‹œì‘í•˜ê¸°</button>
        </div>

        <div id="loading" class="hidden">ì˜¤ë””ì˜¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

        <div id="survey-content" class="hidden">
            <div class="audio-section">
                <p>ì¬ìƒ êµ¬ê°„ì—ëŠ” ë‘ ì‚¬ëŒì˜ ëª©ì†Œë¦¬ê°€ í˜¼í•©ë˜ì–´ ë“¤ë¦½ë‹ˆë‹¤.<br>ê·¸ ì¤‘ ì‹¤ì œë¡œ ì˜ë¯¸ ìˆëŠ” ë°œí™”ë¥¼ í•œë‹¤ê³  íŒë‹¨ë˜ëŠ” í™”ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.</p>
                <p>The audio contains overlapping voices.<br>Please focus your response on the speaker providing
                    meaningful content.</p>
                <audio id="audio-player" controls controlsList="nodownload" preload="auto">
                    Your browser does not support the audio element.
                </audio>
                <p id="file-name" class="hidden" style="font-size: 0.8em; color: #999; margin-top: 10px;"></p>
            </div>

            <form id="survey-form">
                <!-- 1. ë°œí™” ì¸ì§€ ì—¬ë¶€ -->
                <div class="question">
                    <label>1. ë°œí™” ì¸ì§€ ì—¬ë¶€ (Speech Perception)</label>
                    <div class="options">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <label class="option-label">
                                <input type="radio" name="perception_yn" value="Y" required>
                                Yes
                            </label>
                            <span
                                style="font-size: 0.8em; color: #666; text-align: center; margin-top: 5px;">ë“¤ë¦¼<br>(Audible)</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <label class="option-label">
                                <input type="radio" name="perception_yn" value="N" required>
                                No
                            </label>
                            <span style="font-size: 0.8em; color: #666; text-align: center; margin-top: 5px;">ì•ˆ
                                ë“¤ë¦¼<br>(Inaudible)</span>
                        </div>
                    </div>
                </div>

                <!-- 2. ë°œí™” ì¸ì§€ ë‚œì´ë„ -->
                <div class="question">
                    <label>2. ë°œí™” ì¸ì§€ ë‚œì´ë„ (Difficulty)</label>
                    <!-- <p style="font-size: 0.9em; color: #666; margin-top: -5px; margin-bottom: 10px;">
                        1 (ë§¤ìš° ì‰¬ì›€, Very Easy) ~ 5 (ë§¤ìš° ì–´ë ¤ì›€, Very Difficult)
                    </p> -->
                    <div class="options">
                        <label class="option-label"><input type="radio" name="perception_difficulty" value="1" required>
                            1</label>
                        <label class="option-label"><input type="radio" name="perception_difficulty" value="2" required>
                            2</label>
                        <label class="option-label"><input type="radio" name="perception_difficulty" value="3" required>
                            3</label>
                        <label class="option-label"><input type="radio" name="perception_difficulty" value="4" required>
                            4</label>
                        <label class="option-label"><input type="radio" name="perception_difficulty" value="5" required>
                            5</label>
                    </div>
                    <div class="scale-labels">
                        <span>ë§¤ìš° ì‰¬ì›€<br>(Very Easy)</span>
                        <span>ë§¤ìš° ì–´ë ¤ì›€<br>(Very Difficult)</span>
                    </div>
                </div>

                <!-- 3. ìŒí–¥ì  ë¶ˆì¾Œê° -->
                <div class="question">
                    <label>3. ìŒí–¥ì  ë¶ˆì¾Œê° (Annoyance)</label>
                    <!-- <p style="font-size: 0.9em; color: #666; margin-top: -5px; margin-bottom: 10px;">
                        1 (ì „í˜€ ë¶ˆì¾Œí•˜ì§€ ì•ŠìŒ, Not Annoying at all) ~ 5 (ë§¤ìš° ë¶ˆì¾Œí•¨, Very Annoying)
                    </p> -->
                    <div class="options">
                        <label class="option-label"><input type="radio" name="annoyance" value="1" required> 1</label>
                        <label class="option-label"><input type="radio" name="annoyance" value="2" required> 2</label>
                        <label class="option-label"><input type="radio" name="annoyance" value="3" required> 3</label>
                        <label class="option-label"><input type="radio" name="annoyance" value="4" required> 4</label>
                        <label class="option-label"><input type="radio" name="annoyance" value="5" required> 5</label>
                    </div>
                    <div class="scale-labels">
                        <span>ì „í˜€ ë¶ˆì¾Œí•˜ì§€ ì•ŠìŒ<br>(Not Annoying at all)</span>
                        <span>ë§¤ìš° ë¶ˆì¾Œí•¨<br>(Very Annoying)</span>
                    </div>
                </div>

                <button type="submit" id="submit-btn">ì œì¶œí•˜ê³  ë‹¤ìŒ ì˜¤ë””ì˜¤ ë“£ê¸°</button>
            </form>
        </div>

        <!-- 4. ì™„ë£Œ í™”ë©´ -->
        <div id="completion-screen" class="hidden" style="text-align: center; padding: 50px 20px;">
            <h2>ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</h2>
            <p>ëª¨ë“  í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <p>ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>

            <div id="wishlist-container"
                style="margin-top: 40px; padding: 25px; background-color: #fff0f5; border-radius: 15px; box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3); display: flex; flex-direction: column; align-items: center;">
                <div id="wishlist-input-area"
                    style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <input type="text" id="subjective-comment"
                        style="width: 150px; margin-bottom: 15px; padding: 12px; border: 1px solid #ffb6c1; border-radius: 8px; text-align: center;"
                        placeholder="ì…ë ¥í•´ì£¼ì„¸ìš”">
                    <button onclick="submitComment()" id="comment-submit-btn"
                        style="background-color: #d63384; width: 150px;">ğŸ ì‚¬ì£¼ì„¸ìš© ğŸ</button>
                </div>
                <button onclick="closeSurvey()" id="exit-btn" class="hidden"
                    style="background-color: #6c757d; width: 150px;">ì¢…ë£Œí•˜ê¸°</button>
            </div>

            <!-- <button onclick="location.reload()" style="margin-top: 20px; width: auto;">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button> -->
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // config.jsì—ì„œ CONFIG_SCRIPT_URLì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.

        let audioFiles = [];
        let currentAudioFile = '';
        let evaluatorName = '';
        let GOOGLE_SCRIPT_URL = CONFIG_SCRIPT_URL || localStorage.getItem('google_script_url') || '';

        // Fisher-Yates Shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // ì´ˆê¸°í™”
        window.onload = function () {
            // URL ì„¤ì • í™•ì¸
            if (!GOOGLE_SCRIPT_URL) {
                document.getElementById('setup-area').classList.remove('hidden');
                document.getElementById('login-screen').classList.add('hidden');
            } else {
                // ì´ë¦„ ë³µì›
                const savedName = localStorage.getItem('evaluator_name');
                if (savedName) {
                    document.getElementById('login-name').value = savedName;
                }
            }
        };

        function saveScriptUrl() {
            const url = document.getElementById('script-url').value.trim();
            if (!url) {
                alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            GOOGLE_SCRIPT_URL = url;
            localStorage.setItem('google_script_url', url);
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function startSurvey() {
            const nameInput = document.getElementById('login-name');
            const name = nameInput.value.trim();

            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            evaluatorName = name;
            localStorage.setItem('evaluator_name', name);

            document.getElementById('login-screen').classList.add('hidden');
            initSurvey();
        }

        async function initSurvey() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                // ì˜¤ë””ì˜¤ ëª©ë¡ íŒŒì¼ ë¡œë“œ
                const response = await fetch('audio_files.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                audioFiles = await response.json();

                if (!audioFiles || audioFiles.length === 0) {
                    alert('ì˜¤ë””ì˜¤ íŒŒì¼ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                // ëª©ë¡ ì„ê¸°
                shuffleArray(audioFiles);

                // TEST MODE: Limit to 1 file
                audioFiles = audioFiles.slice(0, 1);

                loadNextAudio();
            } catch (error) {
                console.error('Failed to load audio list:', error);
                alert('ì˜¤ë””ì˜¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n[í•´ê²° ë°©ë²•]\n1. ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë¼ë©´ "python -m http.server"ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.\n2. GitHub Pagesë¼ë©´ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.');
            }
        }

        function loadNextAudio() {
            document.getElementById('loading').classList.add('hidden');

            // ë” ì´ìƒ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì™„ë£Œ í™”ë©´ í‘œì‹œ
            if (audioFiles.length === 0) {
                document.getElementById('survey-content').classList.add('hidden');
                document.getElementById('completion-screen').classList.remove('hidden');
                return;
            }

            document.getElementById('survey-content').classList.remove('hidden');

            // í¼ ë¦¬ì…‹
            document.getElementById('survey-form').reset();

            // ìˆœì„œëŒ€ë¡œ í•˜ë‚˜ì”© ê°€ì ¸ì˜¤ê¸°
            currentAudioFile = audioFiles.pop();

            const audioPlayer = document.getElementById('audio-player');

            // config.jsì— ì„¤ì •ëœ AUDIO_BASE_URL ì‚¬ìš©
            // URL ëì— ìŠ¬ë˜ì‹œ(/)ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            let baseUrl = (typeof AUDIO_BASE_URL !== 'undefined' && AUDIO_BASE_URL) ? AUDIO_BASE_URL : '../data/complex_mix/';
            if (!baseUrl.endsWith('/')) {
                baseUrl += '/';
            }

            const audioPath = baseUrl + currentAudioFile;

            audioPlayer.src = audioPath;
            audioPlayer.load(); // ëª…ì‹œì ìœ¼ë¡œ ë¡œë“œ

            // ì˜¤ë””ì˜¤ ë¡œë“œ ì—ëŸ¬ ì²˜ë¦¬
            audioPlayer.onerror = function () {
                console.error('Error loading audio:', audioPath);
                alert('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê²½ë¡œ: ' + audioPath + '\n\níŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            };

            document.getElementById('file-name').textContent = currentAudioFile;
        }

        document.getElementById('survey-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const submitBtn = document.getElementById('submit-btn');

            const data = {
                timestamp: new Date().toISOString(),
                name: evaluatorName,
                audio_file: currentAudioFile,
                perception_yn: formData.get('perception_yn'),
                perception_difficulty: formData.get('perception_difficulty'),
                annoyance: formData.get('annoyance'),
                user_agent: navigator.userAgent
            };

            // "ì œì¶œ ì¤‘" í‘œì‹œ ëŒ€ì‹  ë°”ë¡œ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê° (ì†ë„ ê°œì„ )
            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì „ì†¡
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).catch(error => {
                console.error('Background submission error:', error);
                // ì‹¤íŒ¨í•´ë„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ ì•Šê³  ì§„í–‰ (ë°ì´í„° ìœ ì‹¤ ê°€ëŠ¥ì„±ì€ ìˆì§€ë§Œ ì†ë„ ìš°ì„ )
            });

            // ì¦‰ì‹œ ë‹¤ìŒ ì˜¤ë””ì˜¤ ë¡œë“œ
            loadNextAudio();
        });

        function submitComment() {
            const comment = document.getElementById('subjective-comment').value.trim();
            if (!comment) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.getElementById('comment-submit-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ì „ì†¡ ì¤‘...';

            const data = {
                timestamp: new Date().toISOString(),
                name: evaluatorName,
                comment: comment,
                sheet_name: 'wishlist'
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(() => {
                    alert('ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // Hide input area and show exit button
                    document.getElementById('wishlist-input-area').classList.add('hidden');
                    document.getElementById('exit-btn').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        }

        function closeSurvey() {
            window.close();
            // Fallback if window.close() is blocked
            alert('ì°½ì„ ë‹«ì•„ì£¼ì„¸ìš”.');
        }
    </script>
</body>

</html>